<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Glomok</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="message-container">
      <div id="message"></div>
    </div>
    <canvas id="glcanvas" width="800" height="600">
      Canvas not supported.
    </canvas>
    <div class="start-new-game-container">
      <button id="start-new-game-button" type="button">Start new game</button>
    </div>
    <script src="gl-matrix-min.js"></script>
    <script src="src/shaders.js"></script>
    <script src="src/tex-board.js"></script>
    <script src="src/tex-pieceshadow.js"></script>
    <script src="src/mesh-piece.js"></script>
    <script src="src/view.js"></script>
    <script src="src/draw-setup.js"></script>
    <script src="src/draw.js"></script>
    <script src="src/gameplay.js"></script>
    <script>
      const boardConfig = {
        numLines: 15,
        imageDim: 512, // width/height of image
        imageMargin: 32, // number of pixels around the grid
        worldDim: 1, // world diameter of board (including margin)
      };

      ///////

      window.addEventListener('load', startup, false);

      function startup() {
        const glCanvas = document.getElementById('glcanvas');
        const gl = glCanvas.getContext('webgl');

        const renderState = drawSetup(glCanvas, gl);

        let gameState = new GameState({glCanvas});

        glCanvas.addEventListener('mousemove', (event) => {
          const commands = gameState.update('onMouseMove', glCanvas, getNoPaddingNoBorderCanvasRelativeMousePosition(event));
          runCommands(renderState, gameState, commands);
        });
        glCanvas.addEventListener('mousedown', () => {
          const commands = gameState.update('onClick');
          runCommands(renderState, gameState, commands);
        });
        document.getElementById('start-new-game-button').addEventListener('click', () => {
          switch (gameState.getGameStatus()) {
            case 'new-game':
              break;
            case 'in-progress':
              if (!confirm('Really start new game?')) {
                break;
              }
            case 'game-over':
              gameState = new GameState({glCanvas});
              runCommands(renderState, gameState, [
                ['repaint'],
                ['setOverlayText', ''],
              ]);
              break;
          }
        });

        drawScene(renderState, gameState);
      }

      function runCommands(renderState, gameState, commands) {
        const commandHandlers = {
          repaint() {
            window.requestAnimationFrame(() => {
              drawScene(renderState, gameState);
            });
          },
          setOverlayText(text) {
            document.getElementById('message').innerText = text;
          },
        };

        for (let [cmd, ...cmdArgs] of commands) {
          // TODO don't repaint multiple times?
          if (cmd in commandHandlers) {
            commandHandlers[cmd](...cmdArgs);
          }
        }
      }

      // these two functions from here:
      // https://stackoverflow.com/questions/42309715/how-to-correctly-pass-mouse-coordinates-to-webgl
      function getRelativeMousePosition(event, target) {
        target = target || event.target;
        var rect = target.getBoundingClientRect();

        return {
          x: event.clientX - rect.left,
          y: event.clientY - rect.top,
        }
      }

      // assumes target or event.target is canvas
      function getNoPaddingNoBorderCanvasRelativeMousePosition(event, target) {
        target = target || event.target;
        const pos = getRelativeMousePosition(event, target);

        return [
          pos.x * target.width  / target.clientWidth,
          pos.y * target.height / target.clientHeight,
        ];
      }
    </script>
  </body>
</html>
