<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Glomok</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="message-container">
      <div id="message"></div>
    </div>
    <canvas id="glcanvas" width="700" height="600">
      Canvas not supported.
    </canvas>
    <div class="start-new-game-container">
      <button id="start-new-game-button" type="button">Start new game</button>
    </div>
    <div class="stats">
      Wins:
      <br>
      Black <span id="black-wins">0</span>
      <br>
      White <span id="white-wins">0</span>
    </div>
    <div class="camera-angle-container">
      Camera angle:
      <select id="camera-angle-control">
        <option value="default">default</option>
        <option value="straight-down">straight down</option>
        <option value="too-steep">too steep</option>
      </select>
    </div>
    <script src="gl-matrix-min.js"></script>
    <script src="src/shaders.js"></script>
    <script src="src/tex-board.js"></script>
    <script src="src/tex-pieceshadow.js"></script>
    <script src="src/mesh-piece.js"></script>
    <script src="src/view.js"></script>
    <script src="src/draw-setup.js"></script>
    <script src="src/draw.js"></script>
    <script src="src/gameplay.js"></script>
    <script>
      const boardConfig = {
        numLines: 15,
        imageDim: 512, // width/height of image
        imageMargin: 32, // number of pixels around the grid
        worldDim: 1, // world diameter of board (including margin)
      };

      const persistentState = {
        cameraAngle: 'default',
        blackWins: 0,
        whiteWins: 0,
      };

      ///////

      window.addEventListener('load', startup, false);

      function startup() {
        const glCanvas = document.getElementById('glcanvas');
        const gl = glCanvas.getContext('webgl');

        // try to make canvas full width of browser window
        const fullWidth = (() => {
          // https://stackoverflow.com/questions/3437786/get-the-size-of-the-screen-current-web-page-and-browser-window
          const w = window;
          const d = document;
          const e = d.documentElement;
          const g = d.getElementsByTagName('body')[0];
          const x = w.innerWidth || e.clientWidth || g.clientWidth;
          return x;
        })();
        if (fullWidth > glCanvas.width) {
          glCanvas.width = fullWidth;
        }

        const renderState = drawSetup(glCanvas, gl);

        let gameState = new GameState({cameraAngle: persistentState.cameraAngle, glCanvas});

        glCanvas.addEventListener('mousemove', (event) => {
          const commands = gameState.update('onMouseMove', glCanvas, getNoPaddingNoBorderCanvasRelativeMousePosition(event));
          runCommands(renderState, gameState, commands);
        });
        glCanvas.addEventListener('mousedown', () => {
          const commands = gameState.update('onClick');
          runCommands(renderState, gameState, commands);
        });
        // firefox doesn't reset selected option on refresh, so do it manually
        document.getElementById('camera-angle-control').value = 'default';
        document.getElementById('camera-angle-control').addEventListener('change', (e) => {
          persistentState.cameraAngle = e.target.value;
          const commands = gameState.update('setCameraAngle', {cameraAngle: e.target.value, glCanvas});
          runCommands(renderState, gameState, commands);
        });
        document.getElementById('start-new-game-button').addEventListener('click', () => {
          switch (gameState.getGameStatus()) {
            case 'new-game':
              break;
            case 'in-progress':
              if (!confirm('Really start new game?')) {
                break;
              }
            case 'game-over':
              gameState = new GameState({cameraAngle: persistentState.cameraAngle, glCanvas});
              runCommands(renderState, gameState, [
                ['repaint'],
                ['setOverlayText', ''],
              ]);
              break;
          }
        });
        // TODO - update canvas width on resize

        drawScene(renderState, gameState);
      }

      function runCommands(renderState, gameState, commands) {
        const commandHandlers = {
          repaint() {
            window.requestAnimationFrame(() => {
              drawScene(renderState, gameState);
            });
          },
          setOverlayText(text) {
            document.getElementById('message').innerText = text;
          },
          incrementWinCount(colour) {
            if (['white', 'black'].indexOf(colour) !== -1) {
              const n = ++persistentState[colour + 'Wins'];
              document.getElementById(colour + '-wins').innerText = '' + n;
            }
          }
        };

        for (let [cmd, ...cmdArgs] of commands) {
          // TODO don't repaint multiple times?
          if (cmd in commandHandlers) {
            commandHandlers[cmd](...cmdArgs);
          }
        }
      }

      // these two functions from here:
      // https://stackoverflow.com/questions/42309715/how-to-correctly-pass-mouse-coordinates-to-webgl
      function getRelativeMousePosition(event, target) {
        target = target || event.target;
        var rect = target.getBoundingClientRect();

        return {
          x: event.clientX - rect.left,
          y: event.clientY - rect.top,
        }
      }

      // assumes target or event.target is canvas
      function getNoPaddingNoBorderCanvasRelativeMousePosition(event, target) {
        target = target || event.target;
        const pos = getRelativeMousePosition(event, target);

        return [
          pos.x * target.width  / target.clientWidth,
          pos.y * target.height / target.clientHeight,
        ];
      }
    </script>
  </body>
</html>
