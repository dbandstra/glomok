<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Glomok</title>
    <link rel="stylesheet" href="style.css">
  </head>
  <body>
    <div class="message-container">
      <div id="message"></div>
    </div>
    <canvas id="glcanvas" width="800" height="600">
      Canvas not supported.
    </canvas>
    <div id="message2"></div>
    <script src="gl-matrix-min.js"></script>
    <script src="src/shaders.js"></script>
    <script src="src/tex-board.js"></script>
    <script src="src/tex-pieceshadow.js"></script>
    <script src="src/mesh-piece.js"></script>
    <script src="src/view.js"></script>
    <script src="src/draw-setup.js"></script>
    <script src="src/draw.js"></script>
    <script src="src/gameplay.js"></script>
    <script>
      const boardConfig = {
        numLines: 15,
        imageDim: 512, // width/height of image
        imageMargin: 32, // number of pixels around the grid
        worldDim: 1, // world diameter of board (including margin)
      };

      let shouldRepaint = false;

      ///////

      window.addEventListener('load', startup, false);

      function startup() {
        const gameState = getInitialGameState();

        const glCanvas = document.getElementById('glcanvas');
        const gl = glCanvas.getContext('webgl');

        const renderState = drawSetup(glCanvas, gl);

        calcViewInfo(gameState, {glCanvas});

        glCanvas.addEventListener('mousemove', (event) => {
          const {x, y} = getNoPaddingNoBorderCanvasRelativeMousePosition(event);
          mouseMove(gameState, glCanvas, [x, y]);
          maybeRepaint(renderState, gameState);
        });
        glCanvas.addEventListener('mousedown', () => {
          clickEvent(gameState);
          maybeRepaint(renderState, gameState);
        });

        drawScene(renderState, gameState);
      }

      function repaint() {
        shouldRepaint = true;
      }

      function setOverlayText(text, bgcolor) {
        const el = document.getElementById('message');
        el.innerText = text;
        el.className = `${bgcolor}-bg`;
      }

      function setSmallMessage(text) {
        document.getElementById('message2').innerText = text;
      }

      function maybeRepaint(renderState, gameState) {
        if (shouldRepaint) {
          shouldRepaint = false;
          window.requestAnimationFrame(() => {
            drawScene(renderState, gameState);
          });
        }
      }

      // these two functions from here:
      // https://stackoverflow.com/questions/42309715/how-to-correctly-pass-mouse-coordinates-to-webgl
      function getRelativeMousePosition(event, target) {
        target = target || event.target;
        var rect = target.getBoundingClientRect();

        return {
          x: event.clientX - rect.left,
          y: event.clientY - rect.top,
        }
      }

      // assumes target or event.target is canvas
      function getNoPaddingNoBorderCanvasRelativeMousePosition(event, target) {
        target = target || event.target;
        var pos = getRelativeMousePosition(event, target);

        pos.x = pos.x * target.width  / target.clientWidth;
        pos.y = pos.y * target.height / target.clientHeight;

        return pos;
      }
    </script>
  </body>
</html>
